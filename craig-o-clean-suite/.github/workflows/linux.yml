name: Linux Build

on:
  push:
    branches: [main, develop]
    paths:
      - 'linux/**'
      - 'shared/**'
      - '.github/workflows/linux.yml'
  pull_request:
    branches: [main]
    paths:
      - 'linux/**'
      - 'shared/**'

env:
  FLUTTER_VERSION: '3.19.0'

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run analyzer
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: linux/coverage/

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            libsecret-1-dev libayatana-appindicator3-dev

      - name: Install dependencies
        run: flutter pub get

      - name: Build Linux
        run: flutter build linux --release

      - name: Package tarball
        run: |
          cd build/linux/x64/release/bundle
          tar -czvf ../../../../../craig-o-clean-linux-x64.tar.gz *

      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: linux/craig-o-clean-linux-x64.tar.gz

  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Flatpak dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Install Linux dependencies
        run: |
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            libsecret-1-dev libayatana-appindicator3-dev

      - name: Install dependencies
        run: flutter pub get

      - name: Build Linux release
        run: flutter build linux --release

      - name: Build Flatpak
        run: |
          flatpak-builder --user --install-deps-from=flathub --force-clean build-dir flatpak/com.craigoclean.CraigOClean.yml

      - name: Create Flatpak bundle
        run: |
          flatpak build-bundle ~/.local/share/flatpak/repo craig-o-clean.flatpak com.craigoclean.CraigOClean

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: flatpak
          path: linux/craig-o-clean.flatpak

  build-snap:
    name: Build Snap
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            libsecret-1-dev libayatana-appindicator3-dev

      - name: Install dependencies
        run: flutter pub get

      - name: Build Linux release
        run: flutter build linux --release

      - name: Install Snapcraft
        uses: snapcore/action-build@v1
        id: snapcraft
        with:
          path: linux

      - name: Upload Snap
        uses: actions/upload-artifact@v4
        with:
          name: snap
          path: ${{ steps.snapcraft.outputs.snap }}

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-linux
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            libsecret-1-dev libayatana-appindicator3-dev \
            xvfb

      - name: Install dependencies
        run: |
          cd linux
          flutter pub get

      - name: Run integration tests
        run: |
          cd linux
          xvfb-run flutter test integration_test
